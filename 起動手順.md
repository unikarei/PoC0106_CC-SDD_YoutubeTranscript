# YouTube文字起こしアプリ 起動手順

## ✅ 起動完了状態

このアプリは現在**正常に起動中**です！

### 🌐 アクセスURL
- **フロントエンド（メインUI）**: http://localhost:3000
- **バックエンドAPI**: http://localhost:8000
- **API仕様書（Swagger）**: http://localhost:8000/docs
- **ヘルスチェック**: http://localhost:8000/health

---

## 📝 初回起動手順（次回のために）

### 前提条件
- Docker Desktop（インストール済み）
- Node.js 18以上（フロントをローカルで `npm run dev` したい場合のみ）
- ffmpeg（大容量音声の自動圧縮/分割に使用。Docker運用の場合はコンテナ内に同梱されます）

※ WSL2 の場合、Docker Desktop の Settings → Resources → WSL Integration で
使用中のディストリ（例: Ubuntu）を有効化しておく必要があります。

### ステップ1: バックエンドサービスの起動

```bash
cd /home/ohide/usr8_work/work_23_chatgpt/16_PoCs/0106_cc-sdd
./start_app.sh
```

※ Windows/WSL で Docker Desktop が未起動の場合、`start_app.sh` は Docker Desktop の起動を促しつつ（可能なら自動起動して）待機します。

これで以下が起動します：
- ✅ PostgreSQL（データベース）- ポート5432
- ✅ Redis（タスクキュー）- ポート6379
- ✅ FastAPI（バックエンドAPI）- ポート8000
- ✅ Celeryワーカー（非同期処理）

### ステップ2: サービス起動確認

```bash
docker compose ps
```

全てのサービスが「Up」または「Up (healthy)」になっていることを確認。

### ステップ3: フロントエンドの起動

#### 推奨（Dockerで起動）

```bash
./start_app.sh --with-frontend
```

GUI は http://localhost:3000 で起動します（スクリプトがブラウザで開くこともあります）。

#### 代替（ローカルNodeで起動したい場合）

```bash
cd frontend
npm run dev
```

フロントエンドが http://localhost:3000 で起動します。

---

## 🔧 トラブルシューティング

### サービスが起動しない場合

```bash
# ログを確認
docker-compose logs api
docker-compose logs worker

# 再起動
docker-compose restart

# もし `docker-compose` が無い環境なら、代わりに以下を使用
# docker compose logs api
# docker compose logs worker
# docker compose restart
```

### フロントエンドでエラーが出る場合

```bash
cd frontend
rm -rf node_modules package-lock.json
npm install
npm run dev
```

### 完全リセット

```bash
docker compose down -v  # 全コンテナとボリュームを削除
docker compose up -d    # 再起動
```

---

## 🛑 停止手順

### フロントエンドを停止
ターミナルで `Ctrl+C` を押す

### バックエンドを停止
```bash
docker compose down
```

全てのサービスを停止し、コンテナを削除します。

### データも含めて完全停止
```bash
docker compose down -v
```

データベースのデータも含めて全て削除されます。

---

## 📊 動作確認

### ヘルスチェック
```bash
curl http://localhost:8000/health
```

正常な場合：
```json
{
  "status": "healthy",
  "database": "healthy",
  "redis": "healthy",
  "timestamp": "2025-12-14T10:38:18.455414"
}
```

### フロントエンドアクセス
ブラウザで http://localhost:3000 を開く

---

## 🎯 使い方

1. ブラウザで http://localhost:3000 にアクセス
2. YouTube動画のURLを入力
3. 言語を選択（日本語 or 英語）
4. 「文字起こし開始」ボタンをクリック
5. 処理が完了したら結果を確認・ダウンロード

---

## 🔑 環境変数（.env）

主要な設定：
- `OPENAI_API_KEY`: OpenAI APIキー（Whisper + GPT-4使用）
- `DATABASE_URL`: PostgreSQL接続URL
- `REDIS_URL`: Redis接続URL

必要に応じて `.env` ファイルを編集してください。

### 大容量音声（25MB超）対応

OpenAI のアップロード制限（デフォルト 25MB）を超える可能性がある場合、ワーカーが自動で圧縮/分割して処理します。

設定（任意）：
- `MAX_UPLOAD_MB`：入力ファイルの防御的上限（デフォルト `25`）
- `TARGET_UPLOAD_MB`：圧縮/分割後の目標上限（安全マージン、デフォルト `24`）
- `AUDIO_BITRATE_KBPS`：圧縮ビットレート（デフォルト `48`）
- `CHUNK_OVERLAP_SEC`：分割オーバーラップ秒（デフォルト `0.8`）
- `MAX_SINGLE_CHUNK_SEC`：サイズが小さくても長時間音声を分割する閾値（デフォルト `900`）。長い音声を1リクエストで投げると末尾が欠ける場合があるため、安定化のために分割します。`0` 以下で無効化。

---

## 📦 修正内容（今回の起動で実施）

1. ✅ `yt-dlp` のバージョンを `2024.1.7` → `>=2024.8.6` に修正
2. ✅ `docker-compose.yml` から古い `version: '3.8'` を削除
3. ✅ Dockerfileに `alembic.ini` と `alembic/` の追加
4. ✅ インポートパスを `backend.xxx` → `xxx` に修正
5. ✅ FastAPIの依存性注入の重複を修正
6. ✅ WSL環境にNode.jsをインストール

---

**現在のステータス: ✅ 全サービス正常稼働中**
