# Implementation Plan

## Task Overview
本タスク一覧は、YouTube音声文字起こしWebアプリケーションの実装を段階的に進めるための作業項目を定義します。全8つの要件グループを網羅し、フロントエンド、バックエンド、ワーカー、インフラの各レイヤーを構築します。

## Tasks

### Phase 1: プロジェクト基盤構築

- [x] 1. プロジェクト基盤とインフラストラクチャのセットアップ (P)
- [x] 1.1 (P) 開発環境とプロジェクト構造の初期化
  - Dockerコンテナ構成ファイル作成（API、Worker、Redis、PostgreSQL）
  - 環境変数管理の設定（OpenAI APIキー、データベース接続情報）
  - Docker Composeで全コンポーネントをオーケストレーション
  - _Requirements: 8.3_

- [x] 1.2 (P) データベーススキーマの設計と実装
  - jobsテーブル（id, youtube_url, language, model, status, progress, error_message, timestamps）
  - audio_filesテーブル（id, job_id, file_path, duration_seconds, format, file_size_bytes, title）
  - transcriptsテーブル（id, job_id, text, language_detected, transcription_model）
  - corrected_transcriptsテーブル（id, job_id, corrected_text, original_text, correction_model, changes_summary）
  - インデックス作成（status、created_at、外部キー）
  - マイグレーションスクリプトの作成
  - _Requirements: 1.4, 2.5, 3.4, 4.4, 5.1, 7.7_

- [x] 1.3 (P) タスクキューシステムの構築
  - Celery + Redisのセットアップ
  - タスク定義の基礎構造（transcription_task、correction_task）
  - ワーカープロセスの起動スクリプト
  - タスク再試行ロジックの設定（最大3回、エクスポネンシャルバックオフ）
  - _Requirements: 8.3, 8.4_

### Phase 2: コアサービス実装

- [ ] 2. YouTube音声抽出サービスの実装
- [x] 2.1 AudioExtractorサービスの構築
  - yt-dlp Python APIを使用した音声抽出ロジック
  - YouTube URL検証と動画情報取得（タイトル、長さ、サムネイル）
  - 音声ファイルのダウンロードと保存（M4A/MP3形式）
  - 動画長チェック（60分制限）
  - エラーハンドリング（動画不在、著作権制限、ネットワークエラー）
  - _Requirements: 1.1, 1.3, 1.4, 2.1, 2.3, 2.4, 8.1, 8.2_

- [x] 2.2 音声抽出の進行状況トラッキング
  - ダウンロード進行状況の計算とデータベース更新
  - 進行状況インジケーター用のWebSocket通知（オプション）またはポーリングエンドポイント
  - エラー時のステータス更新とログ記録
  - _Requirements: 2.2, 2.5_

- [ ] 3. 文字起こしサービスの実装
- [x] 3.1 TranscriptionServiceの構築
  - OpenAI Whisper API連携（gpt-4o-mini-transcribe）
  - 音声ファイルの読み込みとAPI送信
  - 言語指定（日本語/英語）とプロンプトヒントの適用
  - ファイルサイズチェック（25MB制限）
  - タイムスタンプ付き文字起こし結果の取得
  - レート制限とタイムアウト処理（サーキットブレーカーパターン）
  - _Requirements: 3.1, 3.2, 4.1, 4.2_

- [x] 3.2 文字起こし結果の処理と検証
  - 話者区別、句読点、段落分けの適用
  - 言語検出と不一致時の警告生成
  - 文字起こしテキストのデータベース保存
  - 進行状況と推定残り時間の計算・更新
  - _Requirements: 3.2, 3.3, 3.5, 4.2, 4.3, 4.5_

- [ ] 4. LLM校正サービスの実装
- [x] 4.1 CorrectionServiceの構築
  - OpenAI GPT-4o-mini API連携
  - 校正プロンプトの設計（誤変換修正、句読点配置、段落整形、文法修正）
  - 文字起こしテキストのLLM送信と校正実行
  - 校正前後の差分計算と変更サマリーの生成
  - トークン制限チェックとテキスト分割処理（必要に応じて）
  - エラーハンドリング（API障害、タイムアウト）
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.8_

- [x] 4.2 校正結果の管理と表示
  - 校正後テキストのデータベース保存
  - 元テキストと校正後テキストの並列表示データ準備
  - 校正結果の採用/破棄処理
  - _Requirements: 7.5, 7.6, 7.7_

- [x] 5. エクスポートサービスの実装 (P)
- [x] 5.1 (P) ExportServiceの構築
  - TXT形式エクスポート（プレーンテキスト）
  - SRT形式エクスポート（字幕ファイル、タイムスタンプ付き）
  - VTT形式エクスポート（WebVTT字幕）
  - タイムスタンプの均等配分ロジック（タイムスタンプ情報がない場合）
  - フォーマット検証とエラーハンドリング
  - _Requirements: 5.1, 5.3, 5.4_

### Phase 3: バックエンドAPI構築

- [ ] 6. RESTful APIエンドポイントの実装
- [x] 6.1 FastAPIアプリケーションのセットアップ
  - FastAPIプロジェクト構造の作成
  - Pydanticモデルでリクエスト/レスポンススキーマ定義
  - CORS設定と認証ミドルウェア（将来対応の準備）
  - エラーハンドラーとグローバル例外処理
  - _Requirements: 6.4_

- [x] 6.2 ジョブ管理エンドポイントの実装
  - POST `/api/jobs/transcribe`: 新規文字起こしジョブ作成
  - GET `/api/jobs/{job_id}/status`: ジョブステータス取得
  - GET `/api/jobs/{job_id}/result`: 文字起こし結果取得
  - POST `/api/jobs/{job_id}/correct`: LLM校正リクエスト
  - YouTube URL検証とエラーレスポンス（400, 422）
  - ジョブIDの検証とエラーレスポンス（404）
  - _Requirements: 1.1, 3.4, 4.4, 7.1_

- [x] 6.3 エクスポートエンドポイントの実装
  - GET `/api/jobs/{job_id}/export?format=txt|srt|vtt`: ファイルダウンロード
  - MIMEタイプの適切な設定（text/plain, application/x-subrip）
  - ファイル名生成（動画タイトル + タイムスタンプ）
  - _Requirements: 5.1, 5.4_

- [x] 6.4 ヘルスチェックとモニタリングエンドポイント (P)
  - GET `/health`: データベース、Redis、外部API接続チェック
  - 構造化ログの実装（JSON形式、ログレベル設定）
  - エラートラッキング統合の準備（Sentry等）
  - _Requirements: 8.3_

- [ ] 6.5 レート制限とセキュリティの実装 (P)
  - IPベースのレート制限（10リクエスト/時間）
  - SQLインジェクション防止（ORMパラメータ化クエリ）
  - APIキー認証の準備（環境変数管理）
  - HTTPS/TLS設定の確認
  - _Requirements: 8.4_

### Phase 4: フロントエンド実装

- [x] 7. WebUIコンポーネントの構築
- [x] 7.1 Next.jsプロジェクトとレイアウトのセットアップ
  - Next.js 14+プロジェクトの初期化
  - TailwindCSSのセットアップとレスポンシブデザイン設定
  - メインレイアウトコンポーネント（ヘッダー、フッター）
  - デスクトップ/モバイルの画面サイズ対応
  - _Requirements: 6.1_

- [x] 7.2 YouTube URL入力とバリデーションUI
  - URL入力フォームコンポーネント
  - クライアント側URL検証（リアルタイムフィードバック）
  - 動画情報表示エリア（タイトル、長さ、サムネイル）
  - エラーメッセージ表示コンポーネント
  - ヘルプテキストとラベルの配置
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 6.3_

- [x] 7.3 言語選択とダウンロードトリガーUI
  - 言語選択ドロップダウン（日本語/英語）
  - モデル選択オプション（gpt-4o-mini-transcribe / gpt-4o-transcribe）
  - ダウンロード/文字起こし開始ボタン
  - ボタンの状態管理（無効化/ローディング）
  - _Requirements: 3.1, 4.1_

- [x] 7.4 進行状況表示とステータスフィードバックUI
  - 進行状況インジケーターコンポーネント（音声抽出、文字起こし、LLM校正）
  - ステータスポーリングロジック（3秒間隔）
  - 推定残り時間の表示
  - 処理ステージの可視化（pending → processing → transcribing → completed）
  - エラー時のフレンドリーなメッセージと対処法の表示
  - _Requirements: 2.2, 3.2, 4.2, 6.2, 6.4, 7.4_

- [x] 7.5 文字起こし結果表示とコピー機能UI
  - 文字起こし結果表示エリア（テキストボックス、読み取り専用）
  - コピーボタンとクリップボードAPI連携
  - テキストの整形表示（段落、句読点の保持）
  - _Requirements: 3.4, 4.4, 5.2_

- [x] 7.6 LLM校正トリガーと比較表示UI
  - LLM校正ボタン（文字起こし完了後に表示）
  - 校正進行状況インジケーター
  - 元テキストと校正後テキストの並列表示（2カラムレイアウト）
  - 切り替えビュー（元テキスト ↔ 校正後テキスト）
  - 校正結果の採用/破棄ボタン
  - 変更サマリーの表示（オプション）
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5, 7.6, 7.7_

- [x] 7.7 エクスポート機能UI
  - エクスポート形式選択ドロップダウン（TXT, SRT, VTT）
  - エクスポートボタンとファイルダウンロードトリガー
  - ダウンロード完了フィードバック
  - _Requirements: 5.1, 5.3, 5.4_

- [ ] 7.8 高負荷時のキュー待機通知UI (P)
  - キュー待機中のメッセージ表示
  - 予想待ち時間の表示
  - キュー位置のリアルタイム更新（オプション）
  - _Requirements: 8.4_

### Phase 5: 統合とテスト

- [ ] 8. ワーカータスクの統合
- [x] 8.1 文字起こしワーカータスクの実装
  - Celeryタスク定義（transcription_taskの完全実装）
  - AudioExtractor → TranscriptionService → データベース更新の統合
  - ステータス更新とエラーハンドリングの組み込み
  - タスク再試行ロジックの検証
  - _Requirements: 2.1, 3.1, 3.4, 4.1, 4.4_

- [x] 8.2 校正ワーカータスクの実装
  - Celeryタスク定義（correction_taskの完全実装）
  - CorrectionService → データベース更新の統合
  - ステータス更新とエラーハンドリングの組み込み
  - _Requirements: 7.2, 7.7_

- [ ] 9. APIとフロントエンドの統合
- [ ] 9.1 フロントエンドからAPIへの接続実装
  - APIクライアントライブラリの作成（fetch/axiosラッパー）
  - 環境変数でAPIエンドポイント管理
  - リクエスト/レスポンスのエラーハンドリング
  - 認証トークンの管理（将来対応）
  - _Requirements: 1.1, 2.1, 3.1, 4.1, 5.1, 7.1_

- [ ] 9.2 エンドツーエンドフローの統合テスト
  - YouTube URL入力 → 音声抽出 → 文字起こし → 結果表示のフロー検証
  - LLM校正 → 前後比較 → 採用/破棄のフロー検証
  - エクスポート機能（TXT/SRT/VTT）の検証
  - エラーシナリオの検証（無効URL、処理失敗、タイムアウト）
  - _Requirements: 1.1, 1.2, 2.3, 3.1, 4.1, 5.1, 7.1, 7.8_

- [ ]* 10. ユニットテストとカバレッジ
- [ ]* 10.1 バックエンドサービスのユニットテスト
  - AudioExtractorのテスト（yt-dlpモック、正常系とエラー系）
  - TranscriptionServiceのテスト（Whisper APIモック、日英検証）
  - CorrectionServiceのテスト（GPT APIモック、校正前後比較）
  - ExportServiceのテスト（フォーマット変換検証）
  - JobManagerのテスト（CRUD操作、ステータス遷移）
  - 各テストでrequirements.mdの受入基準を検証
  - _Requirements: 1.1, 2.1, 2.3, 3.1, 3.3, 4.1, 4.3, 5.3, 5.4_

- [ ]* 10.2 APIエンドポイントのユニットテスト
  - 各エンドポイントのリクエスト/レスポンス検証
  - バリデーションエラーのテスト（400, 422）
  - リソース不在エラーのテスト（404）
  - レート制限のテスト
  - _Requirements: 1.1, 1.2, 3.4, 4.4, 7.1_

- [ ]* 10.3 フロントエンドコンポーネントのテスト
  - URL入力コンポーネントのテスト（バリデーション、エラー表示）
  - 進行状況コンポーネントのテスト（ステータス更新）
  - 結果表示コンポーネントのテスト（テキスト表示、コピー機能）
  - 校正比較コンポーネントのテスト（並列表示、切り替え）
  - エクスポートコンポーネントのテスト（形式選択、ダウンロード）
  - 各テストでrequirements.mdのUI受入基準を検証
  - _Requirements: 1.1, 1.2, 6.1, 6.2, 6.3, 6.4_

- [ ] 11. パフォーマンスと負荷テスト (P)
- [ ] 11.1 (P) パフォーマンステスト
  - 10分動画の処理時間測定（目標: 5分以内）
  - 60分動画の処理時間測定（制限確認）
  - 同時10並行ジョブのスループット測定
  - API応答時間測定（目標: 200ms以内）
  - _Requirements: 8.1, 8.3_

- [ ] 11.2 (P) 負荷テストとスケーラビリティ検証
  - 100リクエスト/分でのシステム挙動確認
  - キューイング動作の検証（高負荷時）
  - Whisper/GPT APIレート制限到達時の挙動確認
  - ワーカープロセスのスケーリング検証（水平スケール）
  - _Requirements: 8.3, 8.4_

## Requirements Coverage

全要件のマッピング確認:

- **Requirement 1 (YouTube動画入力)**: 1.1, 1.2, 2.1, 6.2, 7.2, 9.1, 9.2, 10.1, 10.2, 10.3
- **Requirement 2 (音声ダウンロード)**: 1.2, 2.1, 2.2, 8.1, 9.2, 10.1
- **Requirement 3 (日本語文字起こし)**: 3.1, 3.2, 6.2, 7.3, 7.5, 8.1, 9.1, 9.2, 10.1, 10.2
- **Requirement 4 (英語文字起こし)**: 3.1, 3.2, 6.2, 7.3, 7.5, 8.1, 9.1, 9.2, 10.1, 10.2
- **Requirement 5 (結果管理)**: 5.1, 6.3, 7.5, 7.7, 9.1, 9.2, 10.1
- **Requirement 6 (UI)**: 6.1, 6.4, 7.1, 7.2, 7.4, 10.3
- **Requirement 7 (LLM校正)**: 4.1, 4.2, 6.2, 7.6, 8.2, 9.1, 9.2, 10.2
- **Requirement 8 (パフォーマンス)**: 1.1, 1.3, 2.1, 6.4, 6.5, 7.8, 11.1, 11.2

✅ 全39個の受入基準が上記タスクでカバーされています。

## Task Dependencies

主要な依存関係:
- Phase 1完了 → Phase 2以降が開始可能
- 2.1完了 → 3.1開始可能（音声ファイルが必要）
- 3.2完了 → 4.1開始可能（文字起こし結果が必要）
- 6.1完了 → 6.2, 6.3開始可能
- 6.2完了 → 9.1開始可能
- 7.1完了 → 7.2以降開始可能
- 8.1, 8.2完了 → 9.2開始可能

`(P)`マーク付きタスクは、依存関係がない限り並行実行可能です。

