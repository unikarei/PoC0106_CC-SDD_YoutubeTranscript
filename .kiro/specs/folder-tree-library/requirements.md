# 要件定義: Library フォルダツリー管理（階層 + タグ併用）

## 背景
現状のLibraryは「ジョブ（動画）一覧」を平坦に表示しており、整理・再利用・一括操作が限定的。
本機能では、Libraryをフォルダツリー構造（階層）で管理し、タグと併用して検索/集計/一括操作を可能にする。

## 目的
- Libraryをフォルダツリー化し、動画（アイテム）を階層で整理できる
- タグによる横断的な整理・検索ができる（階層 + タグの併用）
- フォルダ単位でステータス（queued/running/completed/failed）を集計表示できる
- フォルダ単位の既定値（言語/モデル/プロンプト等）で投入・再実行の運用を安定化する
- 一括操作（移動/タグ付け/削除/再実行/再校正/再要約/エクスポート）を提供する

## 用語
- Folder: フォルダ（ツリー構造）。子フォルダを持つ。
- Item: 動画（1動画=1アイテム）。Folderに所属する。
- Artifact: 生成物（例: transcript、proofread、qa、export等）。Itemに紐づく。
- Tag: タグ。Folder/Itemに紐づけ可能（要件で決定）。

## スコープ
- UI: 既存のLibraryリストを「フォルダツリー + フォルダ内一覧」に刷新
- Backend: Folder/Item/Artifact/Tagを分離したデータモデルとAPIを追加
- 既存ジョブ/結果（Job/Transcript/CorrectedTranscript/QaResult）との整合を保つ（移行含む）

## 機能要件

### 1) フォルダ概念（階層 + タグ併用）
- フォルダは階層構造を持つ（親/子）
- タグは階層とは独立して付与できる
- 初期状態としてルート配下にデフォルトフォルダ（例: Inbox）を用意する

### 2) 所属ルール
- 1動画（Item）は、所属フォルダが必ず1つだけ（多重所属は不可）
- Itemのフォルダ移動は可能

### 3) 保存対象の粒度
保存対象（Artifact/メタ情報）の粒度は以下を扱う。
- ① 元動画URL
- ② 文字起こし（生）
- ③ 校正後（LLM）
- ④ Q&A
- ⑤ メタ情報（言語/モデル/実行時刻/所要時間/コスト）

補足:
- ②と④は「値があるなら保存」。なくても自動生成する必要はない
- ②取得後、③の校正は自動実行（フォルダ既定値のデフォルトモデル）

### 4) ステータス管理（フォルダ単位の集計）
- Itemのステータスを以下4分類で扱う
  - queued / running / completed / failed
- フォルダ表示では、配下Itemの件数を4分類で集計表示する
- 集計はフォルダ単位でリアルタイムに反映される（最低限: 画面操作の再取得で反映）

### 5) フォルダごとの既定値
フォルダごとに以下の既定値を保持できる。
- 言語
- 文字起こしモデル
- プロンプト（用途: 再校正/QA/要約等に利用）
- Q&A有無
- 出力形式（txt/md/json）
- 命名規則（例: エクスポートファイル名のテンプレ）

### 6) 検索
- フォルダ内検索（現在選択フォルダ内のItemを対象）
- 全体検索（全フォルダ横断）
- 検索対象:
  - title
  - url
  - 本文（transcript/proofread/qa）
  - タグ
- 期間フィルタ（作成/更新のどちらを基準にするかは設計で明確化）

### 7) 並び替え（ソート）
- フォルダ内一覧で以下でソートできる
  - 更新日時
  - 作成日時
  - 長さ
  - コスト
  - 失敗のみ（フィルタ）
  - 視聴時間（将来の計測項目。データがある場合に限る）

### 8) 一括操作
フォルダ内一覧で複数選択し、以下を実行できる。
- 移動（別フォルダへ）
- タグ付け
- 削除
- 再実行（再文字起こし）
- 再校正
- 再要約
- エクスポート

注記:
- 一括操作は「最小の確認（confirm）」を行う
- 処理中アイテムへの操作可否（例: 削除/移動/再実行）は安全側に倒して設計で明確化する

### 9) UI
- 現Libraryリストをフォルダツリー表示に置き換える
- ツリーでフォルダを選択すると、右側に「フォルダ内一覧」を表示する
- フォルダ編集（新規/名称変更/削除）を提供（必要最小のUI）
- フォルダ既定値（言語/モデル等）はフォルダの設定画面で編集できる

### 10) データモデル
拡張容易性のため、データモデルを以下に分離する。
- Folder
- Item（動画）
- Artifact（transcript等）
- Tag

## 非機能要件
- 既存のデザインシステム/コンポーネント/Tailwindトークンを尊重し、新しい色・フォント・影をハードコードしない
- 既存のJob/Worker処理と整合し、既存データの参照が壊れない
- 大量件数でも破綻しない（最小: ページング/遅延読み込み/検索の制限を設計で定義）

## 非ゴール
- ユーザー認証/共有/権限
- 本格的な全文検索エンジン導入（必要なら後で段階導入）

## 受け入れ基準（Acceptance Criteria）
- フォルダツリーが表示され、フォルダ選択でフォルダ内のItem一覧が見える
- Itemは必ず1つのフォルダに所属し、移動ができる
- フォルダ単位で queued/running/completed/failed の集計が表示される
- フォルダ既定値（言語/モデル/QA有無/出力形式/命名規則）が編集できる
- 検索はフォルダ内/全体の両方ででき、title/url/本文/タグと期間フィルタを持つ
- 並び替えができる（作成/更新/長さ/コスト、失敗のみフィルタ）
- 一括操作（移動/タグ付け/削除/再実行/再校正/再要約/エクスポート）ができる
- 文字起こし（②）が取得できたItemは、自動で校正（③）を開始する（フォルダ既定値のデフォルトモデル）
